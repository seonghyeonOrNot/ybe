name: comment-guide

on:
  issues:
    types: [labeled]

permissions:
  issues: write

jobs:
  comment:
    if: github.event.label.name == 'ready-for-guide'
    runs-on: ubuntu-latest

    steps:
      - name: Add @claude guide trigger comment (with catalog query)
        uses: actions/github-script@v7
        with:
          # 중요: PAT(GH_TOKEN) 사용해야 issue_comment 워크플로가 연쇄로 트리거됨
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const title = issue.data.title || "";
            const body = issue.data.body || "";

            // --- 중복 댓글 방지: 이미 가이드 트리거 댓글이 있으면 스킵 ---
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const already = comments.data.some(c => (c.body || "").includes("@claude 이용가이드 문서를 생성해줘."));
            if (already) {
              console.log("Already commented, skip.");
              return;
            }

            // --- Phase 2: Issue 본문에서 Catalog Query 파싱 ---
            function extractCatalogQuery(issueBody) {
              // "- Query:" 다음 줄부터 다음 "##" 또는 "---" 전까지
              const m = issueBody.match(/- Query:\s*\n([\s\S]*?)(\n##|\n---|$)/i);
              if (!m) return "";
              return (m[1] || "").trim();
            }

            const catalogFile = "data/catalog/features.csv";
            const catalogQuery = extractCatalogQuery(body);

            const catalogHeader = `
            ## Catalog (MUST USE FIRST)
            - File: ${catalogFile}
            - Query:
            ${catalogQuery || "(empty) - you must state '카탈로그 매칭 실패' and list attempted keywords"}
            `.trim();

            const prompt = `
            @claude 이용가이드 문서를 생성해줘.

            ${catalogHeader}

            ## 필수 작업 순서(강제)
            1) 위 Query로 ${catalogFile} 를 먼저 검색해서 관련 기능 3~5개 행을 뽑아라.
            2) 문서 최상단에 "카탈로그 참고 결과" 섹션을 만들고, 뽑은 행을 feature_id/대메뉴/중메뉴/소메뉴/요약 형태로 나열해라.
            3) 그 행들의 용어/정책/절차를 재사용해 아래 템플릿으로 가이드를 작성해라.
            4) 이슈 내용이 카탈로그와 다르면 "변경점" 섹션에 (카탈로그 vs 이슈) 차이를 표로 기록해라.
            5) 카탈로그 매칭 실패 시: "카탈로그 매칭 실패"라고 명시하고 어떤 키워드로 찾았는지 남겨라.

            ## 규칙
            - 코드 변경 금지. 문서만 변경.
            - PR 생성 금지. (브랜치 + 커밋까지만)
            - 단정적인 표현은 피하고, 정책/제약은 명확히
            - 사용자가 따라할 수 있게 “절차”를 단계별로 작성

            ## 출력 파일
            - docs/guide/issue-${issue_number}-guide.md (신규 생성)

            ## 이용가이드 템플릿(반드시 이 순서 고정)
            1. 기능 배경 (Background)
               - 고객/운영 측 불편
               - 기존 방식의 한계
               - 이번 기능이 해결하는 핵심 문제
            
            2. 기능 요약 (Summary)
               - 3~7줄
               - "무엇을 할 수 있게 되었는지" 중심
               - 반드시 핵심 포인트 3개 bullet 포함
            
            3. 기능 상세 설명 (Detailed Description)
               - 기능 동작 흐름을 사용자 관점으로 구체적으로 설명
               - 주요 상태/조건/예외 케이스를 포함
               - 가능하면 예시(입력값/결과) 2개 이상 포함
            
            4. 대상 사용자 / 권한
               - 관리자/사용자 구분
               - 접근 위치/조건
            
            5. 사용 방법(단계별)
               - 최소 5 step
               - 실제 UI에서 클릭하는 순서 느낌으로 작성
            
            6. 화면/메뉴 경로
               - “관리자 > 근태관리 > …” 형태로 경로 표기
               - 관련 화면이 여러 개면 표 형태로 정리
            
            7. 주의사항/제한
               - 정책 제약
               - 데이터 반영 시점
               - 자주 발생하는 오해
            
            8. FAQ (최소 7개)
               - 운영팀/CS가 그대로 답변으로 쓸 수 있게 작성
            
            9. 관련 링크
               - Notion 링크(이슈 본문에 있다면 포함)
               - 관련 이슈/PR 링크(있다면 포함)

            ## 이슈
            Title: ${title}

            Body:
            ${body}
            `.trim();

            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: prompt
            });
