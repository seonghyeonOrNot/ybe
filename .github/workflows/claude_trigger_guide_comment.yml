name: comment-guide

on:
  issues:
    types: [labeled]

permissions:
  issues: write

jobs:
  comment:
    if: github.event.label.name == 'ready-for-guide'
    runs-on: ubuntu-latest

    steps:
      - name: Add @claude trigger comment (guide/policies only)
        uses: actions/github-script@v7
        with:
          # 중요: PAT(GH_TOKEN) 사용해야 issue_comment 워크플로가 연쇄로 트리거됨
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const title = issue.data.title || "";
            const body = issue.data.body || "";
            const labels = (issue.data.labels || []).map(l => (typeof l === "string" ? l : l.name));

            // --- (선택/권장) catalog_query 없으면 트리거 차단 ---
            // Notion->Issue에서 catalog_query 비어있으면 needs-catalog-query 라벨을 붙이도록 해둔 경우에만 의미 있음.
            if (labels.includes("needs-catalog-query")) {
              console.log("needs-catalog-query label present. Skip commenting.");
              return;
            }

            // --- 중복 댓글 방지: 이미 v2-lite 트리거 댓글이 있으면 스킵 ---
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const already = comments.data.some(c => (c.body || "").includes("@claude [guide:v2-lite]"));
            if (already) {
              console.log("Already commented (v2-lite), skip.");
              return;
            }

            // --- Issue 본문에서 Catalog Query 파싱 ---
            function extractCatalogQuery(issueBody) {
              // "- Query:" 다음 줄부터 다음 "##" 또는 "---" 전까지
              const m = issueBody.match(/- Query:\s*\n([\s\S]*?)(\n##|\n---|$)/i);
              if (!m) return "";
              return (m[1] || "").trim();
            }

            const catalogFile = "data/catalog/features.csv";
            const catalogQuery = extractCatalogQuery(body);

            const catalogHeader = `
            ## Catalog (MUST USE FIRST)
            - File: ${catalogFile}
            - Query:
            ${catalogQuery || "(empty) - you must state '카탈로그 매칭 실패' and list attempted keywords"}
            `.trim();

            const prompt = `
            @claude [guide:v2-lite] 아래 2개 문서를 생성해줘. (문서만 변경, 코드 변경 금지)

            ${catalogHeader}

            ## 필수 작업 순서(강제)
            1) 위 Query로 ${catalogFile} 를 먼저 검색해서 관련 기능 3~5개 행을 뽑아라.
            2) 각 문서 최상단에 "카탈로그 참고 결과" 섹션을 만들고, 뽑은 행을 feature_id/대메뉴/중메뉴/소메뉴/요약 형태로 나열해라.
            3) 그 행들의 용어/정책/절차를 재사용해 문서를 작성해라.
            4) 이슈 내용이 카탈로그와 다르면 각 문서에 "변경점" 섹션을 만들고 (카탈로그 vs 이슈) 차이를 표로 기록해라.
            5) 카탈로그 매칭 실패 시: "카탈로그 매칭 실패"라고 명시하고 어떤 키워드로 찾았는지 남겨라.

            ## 규칙
            - 코드 변경 금지. 문서만 변경.
            - PR 생성 금지. (브랜치 + 커밋까지만)
            - 단정적인 표현은 피하고, 정책/제약은 명확히
            - 사용자가 따라할 수 있게 “절차”를 단계별로 작성

            ## 출력 파일 (이번 라운드는 2개만 생성, 경로/파일명 고정)
            1) docs/guide/issue-${issue_number}-guide.md
            2) docs/policies/issue-${issue_number}-policies.md

            ## 문서별 작성 규칙

            ### 1) Guide (사용자용)
            - 아래 템플릿 순서 고정: 배경/요약/상세설명/대상 사용자/절차/화면 경로/주의사항/FAQ/관련 링크
            - 절차는 최소 5 step, 실제 UI 클릭 순서 느낌으로 작성
            - FAQ는 최소 7개

            ### 2) Policies (정책 중심)
            - 정책/제약/예외/우선순위를 표로 정리 (필수)
            - 데이터 반영 시점, 권한별 차이를 명확히
            - 운영/분쟁 소지가 있으면 “리스크” 섹션에 경고 문구 포함

            ## 다음 라운드 안내 (이번 실행에서는 만들지 말 것)
            - QA 시나리오: 10~15개 (Given/When/Then), 별도 라벨(예: ready-for-qa)로 분리 생성 권장
            - Spec 문서도 별도 라벨(예: ready-for-spec)로 분리 생성 권장

            ## 이슈
            Title: ${title}

            Body:
            ${body}
            `.trim();

            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: prompt
            });
