name: comment-guide

on:
  issues:
    types: [labeled]

permissions:
  issues: write

jobs:
  comment:
    if: github.event.label.name == 'ready-for-guide'
    runs-on: ubuntu-latest

    steps:
      - name: Add @claude guide trigger comment
        uses: actions/github-script@v7
        with:
          # 중요: PAT(GH_TOKEN) 사용해야 issue_comment 워크플로가 연쇄로 트리거됨
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const title = issue.data.title || "";
            const body = issue.data.body || "";

            const prompt = `
            @claude 이용가이드 문서를 생성해줘.

            ## 규칙
            - 코드 변경 금지. 문서만 변경.
            - PR 생성 금지. (브랜치 + 커밋까지만)
            - 단정적인 표현은 피하고, 정책/제약은 명확히
            - 사용자가 따라할 수 있게 “절차”를 단계별로 작성

            ## 출력 파일
            - docs/guide/issue-${issue_number}-guide.md (신규 생성)

            ## 이용가이드 템플릿(반드시 이 순서 고정)
            1. 기능 배경 (Background)
               - 고객/운영 측 불편
               - 기존 방식의 한계
               - 이번 기능이 해결하는 핵심 문제
            
            2. 기능 요약 (Summary)
               - 3~7줄
               - "무엇을 할 수 있게 되었는지" 중심
               - 반드시 핵심 포인트 3개 bullet 포함
            
            3. 기능 상세 설명 (Detailed Description)
               - 기능 동작 흐름을 사용자 관점으로 구체적으로 설명
               - 주요 상태/조건/예외 케이스를 포함
               - 가능하면 예시(입력값/결과) 2개 이상 포함
            
            4. 대상 사용자 / 권한
               - 관리자/사용자 구분
               - 접근 위치/조건
            
            5. 사용 방법(단계별)
               - 최소 5 step
               - 실제 UI에서 클릭하는 순서 느낌으로 작성
            
            6. 화면/메뉴 경로
               - “관리자 > 근태관리 > …” 형태로 경로 표기
               - 관련 화면이 여러 개면 표 형태로 정리
            
            7. 주의사항/제한
               - 정책 제약
               - 데이터 반영 시점
               - 자주 발생하는 오해
            
            8. FAQ (최소 7개)
               - 운영팀/CS가 그대로 답변으로 쓸 수 있게 작성
            
            9. 관련 링크
               - Notion 링크(이슈 본문에 있다면 포함)
               - 관련 이슈/PR 링크(있다면 포함)

            ## 이슈
            Title: ${title}

            Body:
            ${body}
            `.trim();

            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: prompt
            });
