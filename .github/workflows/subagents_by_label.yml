name: Run Claude Subagents by Label

on:
  issues:
    types: [labeled]

permissions:
  id-token: write
  issues: write
  contents: read

jobs:
  policy_pm:
    if: github.event.label.name == 'agent:policy-pm'
    runs-on: ubuntu-latest
    steps:
      - name: Run policy-pm subagent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Use the policy-pm subagent.

            Context (Issue):
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            Requirements:
            - Output in Markdown
            - Follow the subagent's required sections exactly

  ux_architect:
    if: github.event.label.name == 'agent:ux-architect'
    runs-on: ubuntu-latest
    steps:
      - name: Run ux-architect subagent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Use the ux-architect subagent.

            Context (Issue):
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            Requirements:
            - Output in Markdown
            - Follow the subagent's required sections exactly

  risk_compliance:
    if: github.event.label.name == 'agent:risk-compliance'
    runs-on: ubuntu-latest
    steps:
      - name: Run risk-compliance subagent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Use the risk-compliance subagent.

            Context (Issue):
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            Requirements:
            - Output in Markdown
            - Follow the subagent's required sections exactly

  qa_engineer:
    if: github.event.label.name == 'agent:qa'
    runs-on: ubuntu-latest
    steps:
      - name: Run qa-engineer subagent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Use the qa-engineer subagent.

            Context (Issue):
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            Requirements:
            - Output in Markdown
            - Include numeric expected results where applicable

  data_analyst:
    if: github.event.label.name == 'agent:data-analyst'
    runs-on: ubuntu-latest
    steps:
      - name: Run data-analyst subagent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Use the data-analyst subagent.

            Context (Issue):
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            Requirements:
            - Output in Markdown
            - Provide KPI definitions with numerator/denominator

  tech_communicator:
    if: github.event.label.name == 'agent:tech-communicator'
    runs-on: ubuntu-latest
    steps:
      - name: Run tech-communicator subagent
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Use the tech-communicator subagent.

            Context (Issue):
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            Requirements:
            - Output in Markdown
            - Use state/event/transaction/rules framing
