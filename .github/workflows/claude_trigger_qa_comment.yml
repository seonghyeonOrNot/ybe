name: comment-qa

on:
  issues:
    types: [labeled]

permissions:
  issues: write

jobs:
  comment:
    if: github.event.label.name == 'ready-for-qa'
    runs-on: ubuntu-latest

    steps:
      - name: Add @claude trigger comment (qa only)
        uses: actions/github-script@v7
        with:
          # 중요: PAT(GH_TOKEN) 사용해야 issue_comment 워크플로가 연쇄로 트리거됨
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const title = issue.data.title || "";
            const body = issue.data.body || "";
            const labels = (issue.data.labels || []).map(l => (typeof l === "string" ? l : l.name));

            if (labels.includes("needs-catalog-query")) {
              console.log("needs-catalog-query label present. Skip commenting.");
              return;
            }

            // 중복 댓글 방지
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const already = comments.data.some(c => (c.body || "").includes("@claude [qa:v1]"));
            if (already) {
              console.log("Already commented (qa:v1), skip.");
              return;
            }

            function extractCatalogQuery(issueBody) {
              const m = issueBody.match(/- Query:\s*\n([\s\S]*?)(\n##|\n---|$)/i);
              if (!m) return "";
              return (m[1] || "").trim();
            }

            const catalogFile = "data/catalog/features.csv";
            const catalogQuery = extractCatalogQuery(body);

            const catalogHeader = `
            ## Catalog (MUST USE FIRST)
            - File: ${catalogFile}
            - Query:
            ${catalogQuery || "(empty) - you must state '카탈로그 매칭 실패' and list attempted keywords"}
            `.trim();

            const prompt = `
            @claude [qa:v1] QA 시나리오 문서를 생성해줘. (문서만 변경, 코드 변경 금지)

            ${catalogHeader}

            ## 필수 작업 순서(강제)
            1) 위 Query로 ${catalogFile} 를 먼저 검색해서 관련 기능 3~5개 행을 뽑아라.
            2) 문서 최상단에 "카탈로그 참고 결과" 섹션을 만들고, 뽑은 행을 feature_id/대메뉴/중메뉴/소메뉴/요약 형태로 나열해라.
            3) 그 행들의 용어/정책/절차를 재사용해 QA 시나리오를 작성해라.
            4) 이슈 내용이 카탈로그와 다르면 "변경점" 섹션에 (카탈로그 vs 이슈) 차이를 표로 기록해라.
            5) 카탈로그 매칭 실패 시: "카탈로그 매칭 실패"라고 명시하고 어떤 키워드로 찾았는지 남겨라.

            ## 규칙
            - 코드 변경 금지. 문서만 변경.
            - PR 생성 금지. (브랜치 + 커밋까지만)
            - Given / When / Then 형식 고정
            - 총 10~15개
            - 정상/예외/권한 케이스가 섞이게 구성 (최소: 정상 5, 예외 3, 권한 2)
            - 각 케이스에 조건(상태/권한/데이터)을 명시
            - 기대 결과(노출/차단/메시지)를 가능한 구체적으로

            ## 출력 파일 (1개, 경로/파일명 고정)
            - docs/qa_scenarios/issue-${issue_number}-qa.md

            ## 이슈
            Title: ${title}

            Body:
            ${body}
            `.trim();

            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: prompt
            });
