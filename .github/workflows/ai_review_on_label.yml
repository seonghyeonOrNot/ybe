name: AI Review (single entry)

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  ai_review:
    if: github.event.label.name == 'ai-run'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build prompt (and export to env)
        shell: bash
        run: |
          bash scripts/ai_review/build_prompt.sh
          {
            echo "CLAUDE_PROMPT<<EOF"
            cat prompt.txt
            echo ""
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          prompt: "${{ env.CLAUDE_PROMPT }}"
          display_report: "true"
          show_full_output: "true"
          anthropic_api_key: "${{ secrets.ANTHROPIC_API_KEY }}"
          github_token: "${{ github.token }}"

      - name: Ensure comment.md exists
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f comment.md ]; then
            echo "comment.md not found. (Claude must write comment.md)"
            ls -al
            exit 1
          fi

      - name: Post comment to issue
        shell: bash
        run: |
          set -euo pipefail
          ISSUE_NUMBER="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
          REPO="${GITHUB_REPOSITORY:?}"
          TOKEN="${{ github.token }}"
          body=$(jq -Rs '{body: .}' < comment.md)

          curl -sS -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -d "$body" >/dev/null

      - name: Mark done / fail and cleanup ai-run
        if: always()
        shell: bash
        run: bash scripts/ai_review/mark_done.sh
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_JOB_STATUS: ${{ job.status }}
