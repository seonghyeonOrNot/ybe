name: AI Review (single entry)

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  ai_review:
    if: github.event.label.name == 'ai-run'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build prompt
        shell: bash
        run: |
          bash scripts/ai_review/build_prompt.sh

      - name: Call Anthropic API -> comment.md
        shell: bash
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${ANTHROPIC_API_KEY:-}" ]; then
            echo "ANTHROPIC_API_KEY is missing"
            exit 1
          fi

          if [ ! -f prompt.txt ]; then
            echo "prompt.txt not found"
            ls -al
            exit 1
          fi

          # prompt.txt -> JSON string (safe)
          PROMPT_JSON=$(jq -Rs . < prompt.txt)

          # ✅ 안정화: 모델 고정 (불필요한 /v1/models 호출 제거)
          MODEL="claude-sonnet-4-6"

          echo "Using model: ${MODEL}"

          MAX_TOKENS=1200
          TEMPERATURE=0.2

          payload=$(jq -n \
            --arg model "$MODEL" \
            --argjson max_tokens "$MAX_TOKENS" \
            --argjson temperature "$TEMPERATURE" \
            --arg content "$PROMPT_JSON" \
            '{
              model: $model,
              max_tokens: $max_tokens,
              temperature: $temperature,
              messages: [
                {role:"user", content: ($content | fromjson)}
              ]
            }')

          # ✅ 안정화: overloaded/rate_limit 재시도 + 백오프
          attempt=0
          max_attempts=5

          while true; do
            attempt=$((attempt+1))
            echo "Anthropic request attempt ${attempt}/${max_attempts}..."

            resp=$(curl -sS https://api.anthropic.com/v1/messages \
              -H "content-type: application/json" \
              -H "x-api-key: ${ANTHROPIC_API_KEY}" \
              -H "anthropic-version: 2023-06-01" \
              -d "$payload" || true)

            if echo "$resp" | jq -e '.type=="error"' >/dev/null 2>&1; then
              err_type=$(echo "$resp" | jq -r '.error.type // empty')
              echo "Anthropic API error: ${err_type}"
              echo "$resp" | jq .

              if [ "$err_type" = "overloaded_error" ] || [ "$err_type" = "rate_limit_error" ]; then
                if [ "$attempt" -lt "$max_attempts" ]; then
                  sleep_sec=$(( attempt * attempt * 4 ))  # 4,16,36,64...
                  echo "Retrying in ${sleep_sec}s..."
                  sleep "$sleep_sec"
                  continue
                fi
              fi

              exit 1
            fi

            break
          done

          echo "$resp" | jq -r '.content[] | select(.type=="text") | .text' > comment.md

          if [ ! -s comment.md ]; then
            echo "comment.md is empty"
            echo "$resp" | jq .
            exit 1
          fi

      - name: Debug prompt (first 200 lines)
        shell: bash
        run: |
          echo "=== prompt.txt head ==="
          sed -n '1,200p' prompt.txt

      - name: Post comment to issue
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          ISSUE_NUMBER="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
          REPO="${GITHUB_REPOSITORY:?}"

          body=$(jq -Rs '{body: .}' < comment.md)

          curl -sS -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -d "$body" >/dev/null

      - name: Mark done / fail and cleanup ai-run
        if: always()
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_JOB_STATUS: ${{ job.status }}
        run: |
          bash scripts/ai_review/mark_done.sh
