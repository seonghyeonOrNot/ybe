name: Claude - PR from Issue (Guarded)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

# 같은 이슈에서 동시에 여러 번 도는 것 방지
concurrency:
  group: claude-from-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: github.event.label.name == 'ready-for-claude'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- 가드레일 1: 중복 실행 방지 + 진행 여부 결정 ---
      - name: Guard - Skip if already processed
        id: guard_processed
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            const issue = await github.rest.issues.get({ owner, repo, issue_number });
            const labels = (issue.data.labels || []).map(l => typeof l === 'string' ? l : l.name);

            core.info(`Labels: ${labels.join(', ')}`);

            const inProgress = labels.includes('claude-in-progress');
            const done = labels.includes('claude-pr-created');

            if (inProgress || done) {
              core.info(`Skipping. inProgress=${inProgress}, done=${done}`);
              core.setOutput('proceed', 'false');
              return;
            }

            core.setOutput('proceed', 'true');

      # --- 가드레일 2: 하루 실행 횟수 제한 (비용 폭주 방지) ---
      - name: Guard - Daily run limit
        id: guard_daily
        if: steps.guard_processed.outputs.proceed == 'true'
        uses: actions/github-script@v7
        env:
          DAILY_LIMIT: "3"
        with:
          github-token: ${{ github.token }}
          script: |
            const dailyLimit = parseInt(process.env.DAILY_LIMIT || "3", 10);

            // UTC 기준 오늘 날짜 YYYY-MM-DD
            const now = new Date();
            const yyyy = now.getUTCFullYear();
            const mm = String(now.getUTCMonth() + 1).padStart(2, "0");
            const dd = String(now.getUTCDate()).padStart(2, "0");
            const today = `${yyyy}-${mm}-${dd}`;

            const repoFull = process.env.GITHUB_REPOSITORY; // owner/repo
            const q = `repo:${repoFull} label:claude-pr-created created:${today}`;

            core.info(`Today(UTC): ${today}`);
            core.info(`Query: ${q}`);

            const res = await github.rest.search.issuesAndPullRequests({ q });
            const count = res.data.total_count;

            core.info(`Today's claude completed count: ${count} / limit: ${dailyLimit}`);

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            if (count >= dailyLimit) {
              core.info("Daily limit reached. Labeling claude-skipped and stopping.");

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: ["claude-skipped"],
              });

              core.setOutput('proceed', 'false');
              return;
            }

            core.setOutput('proceed', 'true');

      # --- 가드레일 3: 진행 상태 라벨링 ---
      - name: Mark in-progress
        if: steps.guard_processed.outputs.proceed == 'true' && steps.guard_daily.outputs.proceed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["claude-in-progress"],
            });

      # --- 실제 실행: Claude가 PR 생성 ---
      - name: Claude Code Action
        if: steps.guard_processed.outputs.proceed == 'true' && steps.guard_daily.outputs.proceed == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      # --- 성공 처리: 라벨 정리 ---
      - name: Mark success
        if: success() && steps.guard_processed.outputs.proceed == 'true' && steps.guard_daily.outputs.proceed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            await github.rest.issues.addLabels({
              owner, repo, issue_number,
              labels: ["claude-pr-created"],
            });

            // 진행중/실패 라벨 정리
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: "claude-in-progress" }); } catch(e) {}
            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: "claude-failed" }); } catch(e) {}

      # --- 실패 처리: 라벨 정리 ---
      - name: Mark failure
        if: failure() && steps.guard_processed.outputs.proceed == 'true' && steps.guard_daily.outputs.proceed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            await github.rest.issues.addLabels({
              owner, repo, issue_number,
              labels: ["claude-failed"],
            });

            try { await github.rest.issues.removeLabel({ owner, repo, issue_number, name: "claude-in-progress" }); } catch(e) {}
