name: Claude - PR from Issue (Guarded)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: claude-from-issue
  cancel-in-progress: false

jobs:
  claude:
    # 1차 가드: 라벨이 ready-for-claude일 때만
    if: github.event.label.name == 'ready-for-claude'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- 가드레일 1: 중복 실행 방지 ---
      - name: Guard - Skip if already processed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          LABELS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }} --jq '.labels[].name' | tr '\n' ' ')
          echo "Labels: $LABELS"

          if echo "$LABELS" | grep -q "claude-in-progress"; then
            echo "Already in progress. Skipping."
            exit 0
          fi

          if echo "$LABELS" | grep -q "claude-pr-created"; then
            echo "Already done. Skipping."
            exit 0
          fi

      # --- 가드레일 2: 하루 실행 횟수 제한 (비용 폭주 방지) ---
      # 기본값 DAILY_LIMIT=10 (원하면 숫자만 바꿔)

      - name: Guard - Daily run limit
        uses: actions/github-script@v7
        env:
          DAILY_LIMIT: "3"
        with:
          github-token: ${{ github.token }}
          script: |
            const dailyLimit = parseInt(process.env.DAILY_LIMIT || "3", 10);

            // UTC 기준 오늘 날짜 YYYY-MM-DD
            const now = new Date();
            const yyyy = now.getUTCFullYear();
            const mm = String(now.getUTCMonth() + 1).padStart(2, "0");
            const dd = String(now.getUTCDate()).padStart(2, "0");
            const today = `${yyyy}-${mm}-${dd}`;

            const repoFull = process.env.GITHUB_REPOSITORY; // owner/repo
            const q = `repo:${repoFull} label:claude-pr-created created:${today}`;

            core.info(`Today(UTC): ${today}`);
            core.info(`Query: ${q}`);

            const res = await github.rest.search.issuesAndPullRequests({ q });
            const count = res.data.total_count;

            core.info(`Today's claude completed count: ${count} / limit: ${dailyLimit}`);

            if (count >= dailyLimit) {
              core.info("Daily limit reached. Labeling claude-skipped and stopping.");

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ["claude-skipped"],
              });

              // 워크플로를 "정상 종료"시키되 이후 스텝 진행은 막기 위해 실패로 종료
              // (원하면 여기서 core.setFailed 대신 return 으로 바꿀 수도 있어)
              return;
            }




      # --- 가드레일 3: 진행 상태 라벨링 ---
      - name: Mark in-progress
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X POST repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels -f labels[]="claude-in-progress"

      # --- 실제 실행: Claude가 PR 생성 ---
      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      # --- 성공 처리: 라벨 정리 ---
      - name: Mark success
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X POST repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels -f labels[]="claude-pr-created"
          gh api -X DELETE repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels/claude-in-progress || true
          gh api -X DELETE repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels/claude-failed || true

      # --- 실패 처리: 라벨 정리 ---
      - name: Mark failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api -X POST repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels -f labels[]="claude-failed"
          gh api -X DELETE repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels/claude-in-progress || true
